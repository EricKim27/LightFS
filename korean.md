# LightFS

# 개요

https://github.com/EricKim27/LightFS

간단한 유닉스 파일시스템.

지원 기능: 파일 읽고 쓰기, 저널링 기능은 없음

### 단어 설명

- 블록: 파일 시스템 내에서, 데이터를 저장하는 구조. 주로 4096 바이트(4KiB)를 가지고 있다.
- 아이노드: 파일이나 디렉토리에 대한 메타데이터(권한, 크기 등)을 저장하는 구조체
- 디렉토리 엔트리: 디렉토리 블록에 있는 구조체로, 디렉토리나 파일의 이름과 아이노드 번호를 가지고 있다.

# 특징

- 모든 구조가 1024*a(a는 1024 약수 또는 배수)바이트 내로 떨어지는 파일시스템이다.
    - 아이노드-256바이트
    - 블럭 4KB
- 오프셋 계산을 1024바이트를 기준으로 연산함. 1024 바이트는 헤더 파일에 LIGHTFS_LOGICAL_BS라는 이름으로 지정되어있다. 이를 논리 블록이라 칭한다.
    - 이와 같은 선택은 타 파일시스템은 오프셋 연산을 블록을 1개가 아닌 여러개를 읽도록 하기에 이를 단순화하기 위해 이렇게 설계하였다.

# mkfs.lightfs

$ mkfs.lightfs <dev>

파티션 내 데이터를 전부 2로 초기화(22 22 22 22 …)

아이노드 개수와 블록 개수를 같게 하기

partition_size = 2048 + 아이노드 개수 - 아이노드 개수 1024로 나눈 나머지 + 1 + 블록 개수 + 블록 개수 1024로 나눈 나머지 + 1 + (256 * 아이노드개수) + (4096 * 블록 개수). 

- 슈퍼 블록 채우고 작성하기
- 루트 아이노드 채우기
- 루트 디엔트리에 “.”, “..” 추가

# 구조

| 1024 바이트 빈 공간 |
| --- |
| 슈퍼블록 |
| 아이노드 비트맵 |
| 데이터 블록 비트맵 |
| 아이노드 |
| 블록 |

모든 구조체에는 char padding이 있는데, 이는 구조체의 크기를 맞추기 위해 있다.

## 아이노드 구조체(256B)

파일의 메타데이터를 포함하고 있는 구조체.

```
                                            - block with block pointers -
+-----------+       +-----------+                 +-------------+
|   inode   | ----> |   inode   | --------------> |   3456467   |
+-----------+       |   info    |                 +-------------+
                    +-----------+                 |     ...     |
                        |                         +-------------+
                        |
                        +---------> +----------+
                                    |  buffer  |
                                    +----------+
```

### 아이노드 정보 구조체

메모리 상에 적재되는 구조체. 데이터 블록 번호를 저장하는 블록 번호와 파일의 데이터가 나중에 적재됨

## Dentry 구조체(64B)

디렉토리에서 한 아이템의 이름, 아이노드 번호를 가지고 있음

```
block of a directory
+------------+-------------------+
| dir header |   total 3 items   |
+------------+-------------------+
|     .      |      4352646      |
+------------+-------------------+
|     ..     |      3253667      |
+------------+-------------------+
|     Docs   |      3423564      |
+------------+-------------------+
```

### Dentry header 구조체(64B)

해당 디렉토리가 가지고 있는 총 파일의 개수를 보관함. 

# 기본적 작동 방식

- 블록 읽기/쓰기
    - 블록은 4KiB의 사이즈를 가짐.
    - 논리적 블록은 1KiB임
    - sb_bread() 함수를 통해 1kb의 데이터를 읽고 버퍼에 저장
    - 저장한 버퍼를 블록 공간을 메모리에 확보하고 데이터를 옮긴다.
    - 변경 시 sync_blk()로 동기화시킨다.
- 아이노드 읽기/쓰기
    - 아이노드 구조체는 256B의 사이즈를 가짐.
    - 블럭을 읽고, 그 블럭 내에서 어느 지점에 해당 아이노드 구조체가 있는지 파악
    - 읽고 버퍼에 저장/변경 사항을 buffer_head 구조체에 저장
    - mark_buffer_as_dirty() 사용
    - 나중에 싱크
- 비트맵 읽기
    - TODO: 생각해보기

# 정의해야 할 오퍼레이션

정의된 함수는 이탤릭체로 변경됨.

- inode_operations
    - ***lookup***
    - ***create***
        - 블록 번호 할당, 부모 폴더에 디엔트리 추가, 아이노드 디스크에 작성, 파일 오퍼레이션 할당, 아이노드 비트맵 필드에 1처리, 데이터 블록 필드에 1처리
    - ***link***
        - 아이노드에 링크된 아이노드 번호를 작성하기(작성할 필드 생각해보기), 디스크에 아이노드 작성하기, 디엔트리에 링크 엔트리 작성
    - unlink
        - 아이노드 삭제, 비트맵 0처리
    - ***mkdir***
        - 아이노드 번호 할당, 블록 번호 할당, 해당 블록에 “.”, “..” 디엔트리 추가하기, 아이노드 비트맵 1처리, 블록 비트맵 1처리
    - ***rmdir***
        - 비트맵에서 0처리, 블록 비트맵에서 0처리, 부모 디엔트리에서 삭제
    - rename
        - 디엔트리 위치 찾아서 이름 필드 변경
    - ~~symlink~~
        - ~~심볼릭 링크 공부하기~~
        - 심볼릭 링크 지원 안 하기로 결정
- super_operations
    - ***fill_super***
    - ***syncfs - 추가 작업 필요***
    - ***statfs***
    - ***put_super***
    - allocate_inode
        - 아이노드 공간 할당(아이노드 구조체 + 아이노드 인포)
    - ***destroy_inode***
    - ***write_inode***
- address_space_operations
    - ***readpage***
    - writepage
    - ***write_begin***
    - ***write_end*** - generic_write_end
- directory_operations
    - ***iterate_shared***
- link_operations
- bitmap_operations
    - ***get_first_bit***
    - ***modify_bit_data*** - 데이터 블록 비트맵에서 1이나 0으로 변경
    - ***modify_bit_inode***  - 아이노드 비트맵에서 1이나 0으로 변경
    - more
- file_operations
    - ***open*** - trunication 생각해보기
        - init file
    - ***read***
        - 아이노드에서 블록 번호 얻기 ⇒ readpage로 읽기 ⇒ 유저 버퍼로 복사 ⇒ 읽은 사이즈 리턴
    - ***write***
        - struct file에서 데이터 필드 정보를 블록에 작성
    - ***llseek*** - generic_file_llseek
    - fsync

# 참고자료

simplefs project(National Cheng Kung University, Taiwan) - [https://github.com/sysprog21/simplefs](https://github.com/sysprog21/simplefs) (파일시스템 드라이버의 작동 원리 연구할 때 사용함, 해당 프로젝트에서 파생된 코드가 아님)

linux vfs documentation - [https://www.kernel.org/doc/html/latest/filesystems/vfs.html](https://www.kernel.org/doc/html/latest/filesystems/vfs.html)

